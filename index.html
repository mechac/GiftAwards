<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ü–æ–¥–∞—Ä–æ–∫ Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            overflow: hidden;
        }

        .gift-card {
            width: 100%;
            max-width: 380px;
            background: rgba(0, 0, 0, 0.52);
            backdrop-filter: blur(18px);
            border-radius: 28px;
            padding: 40px 28px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .instruction {
            font-size: 17px;
            color: rgba(255,255,255,0.85);
            margin-bottom: 32px;
            font-weight: 500;
        }

        .video-container {
            width: 240px;
            height: 240px;
            margin: 0 auto 36px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.4s ease;
            position: relative;
            background: transparent;
        }

        .video-container:hover { transform: scale(1.08); }
        .video-container.animating { 
            cursor: not-allowed; 
            pointer-events: none; 
            transform: scale(1);
        }

        #giftVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        #giftCanvas {
            width: 100%;
            height: 100%;
            display: none;
        }

        .gift-result {
            display: none;
            animation: fadeInUp 0.7s ease forwards;
        }

        .gift-result.show { display: block; }

        .gift-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
            color: #ffffff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .gift-text {
            font-size: 18px;
            line-height: 1.55;
            color: rgba(255, 255, 255, 0.95);
        }

        .user-name {
            font-weight: 800;
            color: #ffffff;
            font-size: 20px;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(25px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(130vh) rotate(900deg);
                opacity: 0;
            }
        }

        .error-message {
            display: none;
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 20px;
            padding: 10px;
            background: rgba(255,0,0,0.1);
            border-radius: 8px;
            text-align: left;
        }

        .error-message.show { display: block; }
    </style>
</head>
<body>

    <div class="gift-card">
        <div class="instruction">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫</div>
        
        <div class="video-container" id="videoContainer">
            <!-- ‚ö†Ô∏è –í–ê–ñ–ù–û: –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä! -->
            <!-- Python: python -m http.server -->
            <!-- Node: npx http-server -->
            <!-- VS Code: "Live Server" extension -->
            <video id="giftVideo" muted playsinline preload="auto" crossorigin="anonymous">
                <source src="gift-animation.mp4" type="video/mp4">
                <!-- –ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∑–∞–∫–æ–¥–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤ base64 –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ -->
                <!-- <source src="data:video/mp4;base64,AAAA..." type="video/mp4"> -->
            </video>
            <canvas id="giftCanvas"></canvas>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="gift-result" id="giftResult">
            <div class="gift-title">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</div>
            <div class="gift-text">
                <span class="user-name" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>,<br>
                —Ç—ã –≤—ã–∏–≥—Ä–∞–ª <b>Telegram Premium</b> –Ω–∞ 1 –º–µ—Å—è—Ü!
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // –§–æ–Ω –ø–æ —Ç–µ–º–µ
        const isDark = tg.colorScheme === 'dark';
        document.body.style.backgroundImage = `url(${isDark ? 'blackfon.jpg' : 'whitefon.jpg'})`;

        // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = tg.initDataUnsafe.user;
        const userName = user 
            ? `${user.first_name} ${user.last_name || ''}`.trim() 
            : '–£–≤–∞–∂–∞–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('userName').textContent = userName;

        const video = document.getElementById('giftVideo');
        const canvas = document.getElementById('giftCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('videoContainer');
        const result = document.getElementById('giftResult');
        const instruction = document.querySelector('.instruction');
        const errorMessage = document.getElementById('errorMessage');
        let playing = false;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ö—Ä–æ–º–∞–∫–µ—è
        const chromaKeyConfig = {
            targetR: 0,
            targetG: 255,
            targetB: 0,
            threshold: 80
        };

        function isChromaKeyPixel(r, g, b) {
            const diff = Math.sqrt(
                Math.pow(r - chromaKeyConfig.targetR, 2) +
                Math.pow(g - chromaKeyConfig.targetG, 2) +
                Math.pow(b - chromaKeyConfig.targetB, 2)
            );
            return diff < chromaKeyConfig.threshold;
        }

        function processFrame() {
            if (!playing || video.paused || video.ended) return;
            
            try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    if (isChromaKeyPixel(data[i], data[i + 1], data[i + 2])) {
                        data[i + 3] = 0;
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–¥—Ä–∞:', e.message);
                
                // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –±–µ–∑ —Ö—Ä–æ–º–∞–∫–µ—è
                canvas.style.display = 'none';
                video.style.display = 'block';
                
                showError('‚ö†Ô∏è –í–∏–¥–µ–æ –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞: ' + e.message);
            }
            
            if (!video.ended) {
                requestAnimationFrame(processFrame);
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 8000);
        }

        container.addEventListener('click', async () => {
            if (playing) return;
            
            try {
                playing = true;
                container.classList.add('animating');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
                if (window.location.protocol === 'file:') {
                    throw new Error('üö´ –ó–∞–ø—É—Å–∫ –∏–∑ —Ñ–∞–π–ª–∞ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (http://localhost). –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ HTML-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö.');
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
                if (video.readyState < 2) {
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => reject(new Error('‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ')), 8000);
                        
                        video.addEventListener('loadeddata', () => {
                            clearTimeout(timeout);
                            resolve();
                        }, { once: true });
                        
                        video.addEventListener('error', (e) => {
                            clearTimeout(timeout);
                            const errorCode = video.error?.code || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                            const errorMessage = video.error?.message || '';
                            reject(new Error(`üìπ –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ. –ö–æ–¥: ${errorCode} ${errorMessage ? '- ' + errorMessage : ''}`));
                        }, { once: true });
                        
                        video.load();
                    });
                }
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
                if (video.videoWidth && video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.style.display = 'block';
                    video.style.display = 'none';
                } else {
                    throw new Error('üìè –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ');
                }
                
                // –ó–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ
                video.currentTime = 0;
                await video.play();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–¥—Ä–æ–≤
                processFrame();
                createConfetti();
                
                // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è
                await new Promise(resolve => {
                    video.onended = resolve;
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                instruction.style.display = 'none';
                result.classList.add('show');
                canvas.style.display = 'none';
                container.style.background = 'transparent';

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
                tg.sendData(JSON.stringify({
                    event: 'gift_opened',
                    user_id: user?.id || null,
                    timestamp: Date.now()
                }));

            } catch (error) {
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
                showError('‚ùå ' + error.message);
                
                // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
                playing = false;
                container.classList.remove('animating');
                video.pause();
                canvas.style.display = 'none';
                video.style.display = 'none';
            }
        });

        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#ffd700', '#ff9ff3', '#74b9ff', '#a29bfe', '#ffeaa7'];
            for (let i = 0; i < 80; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.background = colors[Math.floor(Math.random() * colors.length)];
                    c.style.animation = `confetti-fall ${2 + Math.random() * 2}s linear forwards`;
                    c.style.transform = `rotate(${Math.random() * 360}deg)`;
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 4000);
                }, i * 45);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (window.location.protocol === 'file:') {
            showError('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é! –≠—Ç–æ –ù–ï –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.');
            console.warn('‚ö†Ô∏è –ó–∞–ø—É—Å–∫ –∏–∑ file:// –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ http://localhost:8000 –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ.');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        video.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ:', video.error);
            playing = false;
            container.classList.remove('animating');
            
            let errorText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ. ';
            if (window.location.protocol === 'file:') {
                errorText += '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤–º–µ—Å—Ç–æ file://';
            } else if (video.error) {
                errorText += `–ö–æ–¥ –æ—à–∏–±–∫–∏: ${video.error.code}`;
            }
            
            showError(errorText);
        });
    </script>
</body>
</html>
