<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Подарок Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow: hidden;
            /* Фон устанавливается через JS */
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
        }

        .container {
            width: 100%;
            max-width: 350px;
            text-align: center;
            position: relative; /* Для позиционирования плашки */
        }

        /* Контейнер видео */
        .video-container {
            width: 200px;
            height: 200px;
            margin: 0 auto; /* Убран отступ снизу */
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .video-container:hover {
            transform: scale(1.05);
        }

        .video-container.animating {
            cursor: not-allowed;
            pointer-events: none;
            transform: scale(1);
        }

        #giftVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Подсказка */
        .instruction {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 15px;
        }

        /* Плашка результата - теперь абсолютно позиционирована */
        .gift-result {
            display: none;
            position: absolute;
            top: calc(100% + 20px); /* Позиционируем под контейнером с отступом */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 280px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.20);
            animation: fadeInUp 0.5s ease;
        }

        .gift-result.show {
            display: block;
        }

        .gift-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .gift-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            /* Цвет устанавливается через JS */
        }

        .gift-text {
            font-size: 14px;
            line-height: 1.4;
            color: var(--tg-theme-text-color, #222);
        }

        .user-name {
            font-weight: 700;
            /* Цвет устанавливается через JS */
            word-break: break-word;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 15px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(15px); /* Добавлен translateX для сохранения центрирования */
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Конфетти */
        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            position: absolute;
            animation: confetti-fall 2.5s linear forwards;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="instruction">Нажмите на подарок, чтобы открыть</div>
        
        <div class="video-container" id="videoContainer">
            <video id="giftVideo" muted playsinline preload="auto" poster="gift-preview.jpg">
                <source src="gift-animation.mp4" type="video/mp4">
                Ваш браузер не поддерживает видео
            </video>
        </div>

        <!-- Плашка результата -->
        <div class="gift-result" id="giftResult">
            <div class="gift-title">Поздравляем!</div>
                <div class="gift-text">
                    <span class="user-name" id="userName">Пользователь</span>, вы выиграли
                    <b>Telegram Premium</b> на 1 месяц!
                </div>
            </div>
        </div>

    <script>
        // Инициализация Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // ==== ДИНАМИЧЕСКИЙ ФОН ====
        const isDarkTheme = tg.colorScheme === 'dark';
        const bgImage = isDarkTheme ? 'blackfon.jpg' : 'whitefon.jpg';
        document.body.style.backgroundImage = `url(${bgImage})`;
        
        // ==== ДИНАМИЧЕСКИЙ ЦВЕТ ТЕКСТА ПЛАШКИ ====
        const textColor = isDarkTheme ? '#ffffff' : '#000000';
        // Устанавливаем цвет для заголовка и имени пользователя
        document.querySelector('.gift-title').style.color = textColor;
        document.querySelector('.user-name').style.color = textColor;
        
        // Применяем только цвет текста основного содержимого из темы
        document.body.style.color = tg.themeParams.text_color || '#000000';

        // Получаем данные пользователя
        const user = tg.initDataUnsafe.user;
        const userName = user ? `${user.first_name} ${user.last_name || ''}` : 'Уважаемый пользователь';
        document.getElementById('userName').textContent = userName;

        // Работа с видео
        const video = document.getElementById('giftVideo');
        const videoContainer = document.getElementById('videoContainer');
        let isAnimating = false;

        // Гарантируем показ первого кадра до запуска
        video.addEventListener('loadeddata', () => {
            video.pause();
            video.currentTime = 0;
        });

        // Обработка клика
        videoContainer.addEventListener('click', async () => {
            if (isAnimating) {
                console.log('Анимация уже запущена, подождите...');
                return;
            }

            isAnimating = true;
            videoContainer.classList.add('animating');

            try {
                // Запускаем видео с начала
                video.currentTime = 0;
                await video.play();

                // Запускаем конфетти
                createConfetti();

                // Ждем окончания видео
                await new Promise(resolve => {
                    video.addEventListener('ended', () => {
                        video.pause();
                        video.currentTime = video.duration;
                        resolve();
                    }, { once: true });
                });

                // Показываем плашку
                document.getElementById('giftResult').classList.add('show');
                document.querySelector('.instruction').style.display = 'none';

                // Отправляем результат в бот
                tg.sendData(JSON.stringify({
                    event: 'gift_opened',
                    user_id: user?.id,
                    timestamp: Date.now()
                }));

            } catch (error) {
                console.error('Ошибка воспроизведения:', error);
                alert('Не удалось запустить анимацию. Попробуйте еще раз.');
                isAnimating = false;
                videoContainer.classList.remove('animating');
            }
        });

        // Функция конфетти
        function createConfetti() {
            for (let i = 0; i < 40; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-10px';
                    confetti.style.background = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#ff9ff3'][Math.floor(Math.random() * 5)];
                    confetti.style.animationDelay = Math.random() * 1.5 + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 2500);
                }, i * 40);
            }
        }

        // Обработка ошибок видео (fallback)
        video.addEventListener('error', (e) => {
            console.error('Ошибка загрузки видео:', e);
            document.querySelector('.instruction').textContent = '⚠️ Ошибка загрузки видео';
        });
    </script>
</body>
</html>
